name: Build Jekyll Page

on:
  push:
    branches: [ master ]

jobs:
  jekyll_preview:
    name: Build and deploy Jekyll site
    runs-on: ubuntu-latest

    steps:
      # Checkout the source code
      - name: Checkout 🛎️
        uses: actions/checkout@v2

      # Used downstream for building the jekyll page
      - name: Build the Docker image
        run: docker build -t jeykell-builder .

      # fetch and encrypt access credentials for Google Drive
      - name: Retrieve the secret and decode it to a file
        env:
            API_KEY: ${{ secrets.API_KEY }}
        run: |
            echo $API_KEY > ./_secrets/credentials.json

      # We cache static resources, i.g. optimized images and documents as well as
      # the _site folder and .jekyll-cache directory
      # Make sure to NOT cache the `_secrets` directory, it contains the Google Drive Access Credentials!
      - name: Restore static files from cache
        uses: actions/cache@v3
        with:
          path: |
            gallery
            imgs
            docs
            _site
            .jekyll-cache
          # Updates the cache after every run, by saving a new copy
          key: ${{ runner.os }}-static-files-${{ github.run_id }}
          restore-keys: ${{ runner.os }}-static-files-

      # Allow the docker container to write to the mounted directory
      - name: Give folder access
        run: chmod -R 777 $PWD

      # Build the jekyll page
      - name: Build 🏗️
        run: docker run --rm --volume="$PWD:/srv/jekyll" jeykell-builder

      # Deploy Frontend to GitHub Pages
      - name: Deploy 🚀 to GitHub Pages Branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          cname: preview.zh11.ch